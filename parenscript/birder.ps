(in-package #:chirp.ps)

(defun birder ()
  (chirp::js-response
    (chain angular
	   (module "chirp" #("angular-websocket" "controllers"))
	   (config (lambda (websocket-provider)
		     (chain websocket-provider
			    (prefix "")
			    (uri "ws://localhost:5000")))))

    (chain angular
	   (module "controllers" #())
	   (controller "ChirpController"
		       (lambda ($scope websocket)

			 (chain websocket
				(onopen (lambda ()
					  (chain console (log "connected"))
					  (chain websocket (send "message")))))

			 (chain websocket
				(onmessage (lambda (event)
					     (chain console (log "message: " (@ event data))))))
			 nil)))))
